# Artifact A80: VCPG - JANE AI Integration Plan

# Date Created: C74
# Updated on: C78 (Update model name to gpt-oss-20b)
# Author: AI Model

- **Key/Value for A0:**
- **Description:** A design document for the full-stack architecture of the JANE AI assistant, covering the backend proxy, WebSocket communication, and state-aware prompt engineering.
- **Tags:** guide, planning, feature, ai, jane, chat, websockets, llm

## 1. Vision & Goal

The goal is to integrate the AI assistant, JANE, as a core component of the training experience. JANE must be more than a simple chatbot; she must be a state-aware, contextually intelligent partner for the trainee. This document outlines the architecture to achieve this, focusing on a secure backend proxy and real-time communication.

## 2. User Experience Flow

1.  **Invocation:** A user interacts with JANE in one of two ways:
    *   **Direct Query:** Typing a question into the dedicated AI chat panel.
    *   **Contextual Query:** Highlighting text anywhere in the UI and selecting "Ask JANE" from the context menu.
2.  **Request:** The client sends the query and relevant context (the active `instanceId`) to the backend via a WebSocket connection.
3.  **Backend Processing:** The backend receives the query, gathers the current state of the user's scenario, determines the user's specific role (e.g., `trainee1`), constructs a detailed prompt, and sends it to the external LLM.
4.  **Response:** The LLM streams a response back to the backend, which in turn streams it to the client.
5.  **Display:** The client UI displays the streaming response from JANE in the AI chat panel.

## 3. Technical Architecture

### 3.1. Backend (`apps/backend`)

A new `AiModule` will be created to encapsulate all AI-related logic.

-   **`ai.gateway.ts` (WebSocket):**
    -   **Namespace:** `/ai`
    -   **Authentication:** Uses the `WsJwtGuard` to authenticate connections.
    -   **Event (`askJane`):** Listens for incoming queries from the client.
        -   **Payload:** `{ query: string, instanceId: string }`
        -   **Action:** Calls the `AiService` to process the request and streams the response back to the originating client.

-   **`ai.service.ts`:**
    -   **Dependencies:** `ScenariosService`, `ConfigService`.
    -   **`processQuery(query, instanceId, userId)` Method:**
        1.  **Fetch State:** Calls `ScenariosService` to get the full `ScenarioInstance` data, including the team members list.
        2.  **Determine User Context:** Finds the user's index in the team list to determine their dynamic username (e.g., `trainee1`).
        3.  **Construct Prompt:** Assembles a detailed prompt for the LLM. This prompt will include:
            *   JANE's core persona (from A40).
            *   The user's query.
            *   **Live Scenario Data:** A summary of the current game state (e.g., list of UAVs and their statuses, current score, active objectives).
            *   **User-Specific Context:** The user's assigned in-game username (`trainee1`).
        4.  **Proxy to LLM:** Makes a streaming `fetch` request to the LLM URL defined in the environment variables (`http://192.168.1.85:1234/v1/...`) using the `unsloth/gpt-oss-20b` model.
        5.  **Return Stream:** Returns the streaming response to the gateway.

### 3.2. Frontend (`apps/client`)

-   **`useAiStore.ts` (Zustand Store):**
    -   **State:** `conversation: { author: 'user' | 'jane', text: string }[]`, `isLoading: boolean`.
    -   **Actions:** `askJane(query)`, `addMessage(message)`, `streamJaneResponse(stream)`.
    -   Manages the WebSocket connection to the `/ai` namespace.

-   **`AiPanel.tsx`:**
    -   The primary UI for JANE.
    -   Renders the `conversation` from the `useAiStore`.
    -   Provides an input field that calls the `askJane` action.

-   **`ContextMenu.tsx`:**
    -   The "Ask JANE" option will call `useAiStore.getState().askJane(selectedText)`.

This architecture ensures that JANE has access to all necessary real-time information to provide intelligent, context-aware, and personalized assistance, fulfilling her role as a core part of the "Battle School" experience.