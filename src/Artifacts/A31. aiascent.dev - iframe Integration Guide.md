# Artifact A31: aiascent.dev - iframe Integration Guide

# Date Created: C29
# Author: AI Model & Curator

- **Key/Value for A0:**
- **Description:** Explains the root cause of cross-domain cookie issues when embedding authenticated applications (like `aiascent.game` with NextAuth) in an iframe and provides the solution.
- **Tags:** iframe, authentication, cookies, samesite, nextauth, security, integration

## 1. Overview

This guide addresses the login failure observed when embedding `aiascent.game` within an `iframe` on the `aiascent.dev/showcase` page. The root cause is a browser security feature related to how cookies are handled in cross-site contexts.

## 2. The Problem: Cross-Site Cookie Rejection

Modern browsers have implemented stricter security policies to prevent Cross-Site Request Forgery (CSRF) attacks. A key part of this is the `SameSite` attribute on cookies.

*   **The Console Error:** You observed errors like `Cookie “__Host-next-auth.csrf-token” has been rejected because it is in a cross-site context and its “SameSite” is “Lax” or “Strict”.`
*   **Root Cause:** The `aiascent.game` website (which uses NextAuth.js) sets authentication cookies with a `SameSite` policy of `Lax` by default. This policy means the browser will only send the cookie if the request originates from the *same site* (`aiascent.game`). When the game is loaded in an `iframe` on `aiascent.dev`, the browser correctly identifies this as a "cross-site" context and refuses to send the `Lax` cookies, causing the authentication to fail.

## 3. The Solution: `SameSite=None` and `Secure`

To fix this, the `aiascent.game` application must be configured to tell browsers that its authentication cookies are *intended* to be used in a cross-site context. This requires making two specific changes to the cookie configuration within the `aiascent.game` project.

1.  **`SameSite='none'`:** This attribute explicitly tells the browser that the cookie can be sent with cross-site requests (like from an `iframe`).
2.  **`Secure=true`:** Using `SameSite='none'` is only allowed if the cookie is also marked as `Secure`. This ensures the cookie is only ever sent over an HTTPS connection, which is a critical security measure.

### 3.1. Required Code Change in `aiascent.game`

The following change needs to be made in the NextAuth configuration file within the `aiascent.game` project (likely located at `src/pages/api/auth/[...nextauth].ts` or a similar path).

```typescript
// In the aiascent.game project's NextAuth options...

export const authOptions: NextAuthOptions = {
  // ... your other providers (Google, etc.)
  providers: [
    // ...
  ],
  
  // ADD OR MODIFY THIS COOKIES SECTION
  cookies: {
    sessionToken: {
      name: `__Secure-next-auth.session-token`,
      options: {
        httpOnly: true,
        sameSite: 'none', // <--- CRITICAL CHANGE
        path: '/',
        secure: true,   // <--- CRITICAL CHANGE
        // If you have a custom domain, you might also need:
        // domain: ".aiascent.game", 
      },
    },
    // You may need to apply similar settings for other NextAuth cookies
    // like csrfToken, callbackUrl, etc., if issues persist.
  },

  // ... rest of your configuration
};
```

**Important Note:** This change must be deployed with the `aiascent.game` application. It cannot be fixed from the `aiascent.dev` side, as the cookie-setting behavior is controlled by the embedded site.

## 4. Refresh Button Implementation

To improve the user experience of the embedded game, a refresh button has been added to the showcase tab. This allows the user to reload the `iframe`'s content without reloading the entire `aiascent.dev` page.

This is implemented in `ShowcaseTabs.tsx` using a React `ref` to access the `iframe`'s `contentWindow` and trigger a reload.

```typescript
// Example from ShowcaseTabs.tsx

const iframeRef = useRef<HTMLIFrameElement>(null);

const handleRefresh = () => {
  if (iframeRef.current) {
    iframeRef.current.contentWindow?.location.reload();
  }
};

// ... in the JSX ...
<button onClick={handleRefresh}>Refresh Game</button>
<iframe ref={iframeRef} src="https://aiascent.game/" />